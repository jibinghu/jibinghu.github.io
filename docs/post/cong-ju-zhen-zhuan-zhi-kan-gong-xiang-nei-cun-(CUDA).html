<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark_high_contrast" data-light-theme="light_high_contrast" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    
    <link rel="icon" href="https://q6.itc.cn/q_70/images01/20240415/2cdb0abd9b724802baff3b9199d3fbc4.jpeg"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="### ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDAçš„ä½¿ç”¨ï¼šBank Conflictä¸Memory Coalesce)
---
- [çŸ©é˜µè½¬ç½®çš„å‡ ç§æ–¹æ³•ï¼š](#sector_1)
  - [çŸ©é˜µè½¬ç½®æœ´ç´ å®ç°ï¼š](#sector_1)
  - [åˆ©ç”¨å…±äº«å†…å­˜åˆå¹¶è®¿å­˜ï¼š](#sector_2)
  - [åˆ©ç”¨ padding è§£å†³ bank conflictï¼š](#sector_3)
  - [å¢åŠ æ¯ä¸ªçº¿ç¨‹çš„å¤„ç†å…ƒç´ ä¸ªæ•°ï¼š](#sector_4)
  - [å‘é‡åŒ–å­˜å–ï¼š](#sector_5)
- [çŸ©é˜µè½¬ç½®ç»¼åˆåº”ç”¨ï¼š](#chapter_2)
  - [Floatæ•°æ®ç±»å‹è½¬ç½®ï¼š](#float)
  - [Doubleæ•°æ®ç±»å‹è½¬ç½®ï¼š](#double)
---
> çŸ©é˜µè½¬ç½®æ˜¯ä¸€ç§åŸºç¡€çš„çŸ©é˜µæ“ä½œ, å³å°†äºŒç»´çŸ©é˜µçš„è¡Œåˆ—è¿›è¡Œåè½¬ï¼Œæœ¬æ–‡ä¸»è¦å›´ç»•è¡Œä¸»åºçš„äºŒç»´å•ç²¾åº¦çŸ©é˜µçš„è½¬ç½®è€ƒè™‘ç›¸å…³çš„ä¼˜åŒ–ã€‚">
<meta property="og:title" content="ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDA)">
<meta property="og:description" content="### ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDAçš„ä½¿ç”¨ï¼šBank Conflictä¸Memory Coalesce)
---
- [çŸ©é˜µè½¬ç½®çš„å‡ ç§æ–¹æ³•ï¼š](#sector_1)
  - [çŸ©é˜µè½¬ç½®æœ´ç´ å®ç°ï¼š](#sector_1)
  - [åˆ©ç”¨å…±äº«å†…å­˜åˆå¹¶è®¿å­˜ï¼š](#sector_2)
  - [åˆ©ç”¨ padding è§£å†³ bank conflictï¼š](#sector_3)
  - [å¢åŠ æ¯ä¸ªçº¿ç¨‹çš„å¤„ç†å…ƒç´ ä¸ªæ•°ï¼š](#sector_4)
  - [å‘é‡åŒ–å­˜å–ï¼š](#sector_5)
- [çŸ©é˜µè½¬ç½®ç»¼åˆåº”ç”¨ï¼š](#chapter_2)
  - [Floatæ•°æ®ç±»å‹è½¬ç½®ï¼š](#float)
  - [Doubleæ•°æ®ç±»å‹è½¬ç½®ï¼š](#double)
---
> çŸ©é˜µè½¬ç½®æ˜¯ä¸€ç§åŸºç¡€çš„çŸ©é˜µæ“ä½œ, å³å°†äºŒç»´çŸ©é˜µçš„è¡Œåˆ—è¿›è¡Œåè½¬ï¼Œæœ¬æ–‡ä¸»è¦å›´ç»•è¡Œä¸»åºçš„äºŒç»´å•ç²¾åº¦çŸ©é˜µçš„è½¬ç½®è€ƒè™‘ç›¸å…³çš„ä¼˜åŒ–ã€‚">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jibinghu.github.io/post/cong-ju-zhen-zhuan-zhi-kan-gong-xiang-nei-cun-%28CUDA%29.html">
<meta property="og:image" content="https://q6.itc.cn/q_70/images01/20240415/2cdb0abd9b724802baff3b9199d3fbc4.jpeg">
<title>ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDA)</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>
<style>.markdown-alert{padding:0.5rem 1rem;margin-bottom:1rem;border-left:.25em solid var(--borderColor-default,var(--color-border-default));}.markdown-alert .markdown-alert-title {display:flex;font-weight:var(--base-text-weight-medium,500);align-items:center;line-height:1;}.markdown-alert>:first-child {margin-top:0;}.markdown-alert>:last-child {margin-bottom:0;}</style><style>.markdown-alert.markdown-alert-tip {border-left-color:var(--borderColor-success-emphasis, var(--color-success-emphasis));background-color:var(--color-success-subtle);}.markdown-alert.markdown-alert-tip .markdown-alert-title {color: var(--fgColor-success,var(--color-success-fg));}</style><style>.markdown-alert.markdown-alert-caution {border-left-color:var(--borderColor-danger-emphasis, var(--color-danger-emphasis));background-color:var(--color-danger-subtle);}.markdown-alert.markdown-alert-caution .markdown-alert-title {color: var(--fgColor-danger,var(--color-danger-fg));}</style>



<body>
    <div id="header">
<h1 class="postTitle">ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDA)</h1>
<div class="title-right">
    <a href="https://jibinghu.github.io" id="buttonHome" class="btn btn-invisible circle" title="é¦–é¡µ">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/jibinghu/jibinghu.github.io/issues/4" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="åˆ‡æ¢ä¸»é¢˜">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><h3>ä»çŸ©é˜µè½¬ç½®çœ‹å…±äº«å†…å­˜(CUDAçš„ä½¿ç”¨ï¼šBank Conflictä¸Memory Coalesce)</h3>
<hr>
<ul>
<li><a href="#sector_1">çŸ©é˜µè½¬ç½®çš„å‡ ç§æ–¹æ³•ï¼š</a>
<ul>
<li><a href="#sector_1">çŸ©é˜µè½¬ç½®æœ´ç´ å®ç°ï¼š</a></li>
<li><a href="#sector_2">åˆ©ç”¨å…±äº«å†…å­˜åˆå¹¶è®¿å­˜ï¼š</a></li>
<li><a href="#sector_3">åˆ©ç”¨ padding è§£å†³ bank conflictï¼š</a></li>
<li><a href="#sector_4">å¢åŠ æ¯ä¸ªçº¿ç¨‹çš„å¤„ç†å…ƒç´ ä¸ªæ•°ï¼š</a></li>
<li><a href="#sector_5">å‘é‡åŒ–å­˜å–ï¼š</a></li>
</ul>
</li>
<li><a href="#chapter_2">çŸ©é˜µè½¬ç½®ç»¼åˆåº”ç”¨ï¼š</a>
<ul>
<li><a href="#float">Floatæ•°æ®ç±»å‹è½¬ç½®ï¼š</a></li>
<li><a href="#double">Doubleæ•°æ®ç±»å‹è½¬ç½®ï¼š</a></li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<p>çŸ©é˜µè½¬ç½®æ˜¯ä¸€ç§åŸºç¡€çš„çŸ©é˜µæ“ä½œ, å³å°†äºŒç»´çŸ©é˜µçš„è¡Œåˆ—è¿›è¡Œåè½¬ï¼Œæœ¬æ–‡ä¸»è¦å›´ç»•è¡Œä¸»åºçš„äºŒç»´å•ç²¾åº¦çŸ©é˜µçš„è½¬ç½®è€ƒè™‘ç›¸å…³çš„ä¼˜åŒ–ã€‚</p>
</blockquote>
<p>çŸ©é˜µçš„è½¬ç½®å°±æ˜¯å°†çŸ©é˜µä¸­çš„å…ƒç´ æŒ‰ç…§ä¸»å¯¹è§’çº¿è¿›è¡Œäº¤æ¢ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºä¸€ä¸ªçŸ©é˜µ $A$ï¼Œå…¶è½¬ç½®çŸ©é˜µ $A^T$ çš„å®šä¹‰æ˜¯ï¼š $A^T[i][j] = A[j][i]$ ã€‚è¿™æ„å‘³ç€ï¼ŒçŸ©é˜µ $A$ çš„ç¬¬ $i$ è¡Œç¬¬ $j$ åˆ—çš„å…ƒç´ åœ¨è½¬ç½®çŸ©é˜µ $A^T$ ä¸­å˜æˆäº†ç¬¬ $j$ è¡Œç¬¬ $i$ åˆ—çš„å…ƒç´ ã€‚æ¢å¥è¯è¯´ï¼ŒçŸ©é˜µä¸­çš„å…ƒç´ æ˜¯ç›¸å¯¹äºä¸»å¯¹è§’çº¿å¯¹ç§°äº¤æ¢çš„ã€‚</p>
<p><strong>ğŸŒ°ï¼š</strong></p>
<div class="highlight highlight-source-c++"><pre class="notranslate">Original matrix:
    <span class="pl-c1">1</span>    <span class="pl-c1">2</span>    <span class="pl-c1">3</span>    <span class="pl-c1">4</span>
    <span class="pl-c1">5</span>    <span class="pl-c1">6</span>    <span class="pl-c1">7</span>    <span class="pl-c1">8</span>
    <span class="pl-c1">9</span>   <span class="pl-c1">10</span>   <span class="pl-c1">11</span>   <span class="pl-c1">12</span>
   <span class="pl-c1">13</span>   <span class="pl-c1">14</span>   <span class="pl-c1">15</span>   <span class="pl-c1">16</span>
Transposed matrix:
    <span class="pl-c1">1</span>    <span class="pl-c1">5</span>    <span class="pl-c1">9</span>   <span class="pl-c1">13</span>
    <span class="pl-c1">2</span>    <span class="pl-c1">6</span>   <span class="pl-c1">10</span>   <span class="pl-c1">14</span>
    <span class="pl-c1">3</span>    <span class="pl-c1">7</span>   <span class="pl-c1">11</span>   <span class="pl-c1">15</span>
    <span class="pl-c1">4</span>    <span class="pl-c1">8</span>   <span class="pl-c1">12</span>   <span class="pl-c1">16</span></pre></div>
<hr>
<h4>çŸ©é˜µè½¬ç½®çš„å‡ ç§æ–¹æ³•ï¼š</h4>
<h5>çŸ©é˜µè½¬ç½®æœ´ç´ å®ç°ï¼š {#sector_1}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate">__global__ <span class="pl-k">void</span> <span class="pl-en">mat_transpose_kernel_v0</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">const</span> <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * blockDim.<span class="pl-smi">x</span> + threadIdx.<span class="pl-smi">x</span>;
    <span class="pl-k">const</span> <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * blockDim.<span class="pl-smi">y</span> + threadIdx.<span class="pl-smi">y</span>;

    <span class="pl-k">if</span> (y &lt; M &amp;&amp; x &lt; N) {
        odata[x * M + y] = idata[y * N + x];
    }
}


<span class="pl-k">void</span> <span class="pl-en">mat_transpose_v0</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> BLOCK_SZ = <span class="pl-c1">16</span>;
    dim3 <span class="pl-smi">block</span>(BLOCK_SZ, BLOCK_SZ);
    dim3 <span class="pl-smi">grid</span>((N + BLOCK_SZ - <span class="pl-c1">1</span>) / BLOCK_SZ, (M + BLOCK_SZ - <span class="pl-c1">1</span>) / BLOCK_SZ));
    mat_transpose_kernel_v0&lt;&lt;&lt;grid, block&gt;&gt;&gt;(idata, odata, M, N);
}</pre></div>
<blockquote>
<p>çŸ©é˜µè½¬ç½®çš„æœ´ç´ å®ç°éå¸¸ç›´è§‚, æ€è·¯å³ä½¿ç”¨äºŒç»´çš„çº¿ç¨‹/çº¿ç¨‹å—æ’å¸ƒ, è®©æ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸€ä¸ªçŸ©é˜µå…ƒç´ çš„è½¬ç½®. å®ç°ä¸Š, åªéœ€è¦å°†çŸ©é˜µçš„è¡Œåˆ—ç´¢å¼• x y è¿›è¡Œåè½¬å³å¯.<br>
éœ€è¦æ³¨æ„çš„æ˜¯ grid å’Œ block çš„ä¸­ç»´åº¦è®¾ç½®ä¸å¤šç»´æ•°ç»„ä¸­çš„è¡¨ç¤ºæ˜¯ç›¸åçš„, å³ grid.x åº”è¯¥å¯¹åº” N ç»´åº¦, grid.y åº”è¯¥å¯¹åº” M ç»´åº¦.</p>
</blockquote>
<p>ç»“åˆçŸ©é˜µè½¬ç½®çš„é€»è¾‘ä»¥åŠ Nsight Compute å®¹æ˜“åˆ¤æ–­å‡º, çŸ©é˜µè½¬ç½®æœ¬èº«æ˜¯ä¸€ä¸ª memory-bound çš„ kernel, å› ä¸ºå…¶æ ¸å¿ƒæ˜¯å®ŒæˆçŸ©é˜µå†…å­˜æ’å¸ƒçš„è½¬æ¢, è¿™ä¸ªè¿‡ç¨‹åŸºæœ¬ä¸æ¶‰åŠè®¡ç®—, å› æ­¤å¯¹è¯¥ kernel ä¼˜åŒ–å¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯æé«˜è®¿å­˜æ€§èƒ½.</p>
<p><em>æœ´ç´ å®ç°ç›´æ¥æ“ä½œçŸ©é˜µæ‰€åœ¨çš„ GMEM, ç›´è§‚çœ‹æ¥, çŸ©é˜µè½¬ç½®ä¸ä¼šæ¶‰åŠæ•°æ®çš„é‡ç”¨, ç›´æ¥æ“ä½œ GMEM æœ¬èº«æ²¡æœ‰é—®é¢˜, ä½†æ­¤æ—¶åº”è¯¥æ³¨æ„ GMEM çš„è®¿å­˜ç‰¹æ€§, å…¶ä¸­å¾ˆé‡è¦çš„å³ GMEM çš„è®¿å­˜åˆå¹¶, å³è¿ç»­çº¿ç¨‹è®¿é—®çš„ GMEM ä¸­çš„æ•°æ®åœ°å€æ˜¯è¿ç»­çš„, å¯ä»¥å°†å¤šä¸ªçº¿ç¨‹çš„å†…å­˜è®¿é—®åˆå¹¶ä¸ºä¸€ä¸ª(æˆ–å¤šä¸ª)å†…å­˜è®¿é—®, ä»è€Œå‡å°‘è®¿å­˜æ¬¡æ•°, æé«˜å¸¦å®½åˆ©ç”¨ç‡. åœ¨ Version 0 çš„ kernel ä¸­, å®¹æ˜“çœ‹å‡ºè¯»å–æ—¶ idata[y * N + x] æ˜¯è®¿å­˜åˆå¹¶çš„, å› ä¸ºè¿ç»­çº¿ç¨‹å¯¹åº”çš„ x æ˜¯è¿ç»­çš„, å³è®¿é—®çŸ©é˜µåŒä¸€è¡Œè¿ç»­çš„åˆ—; ä½†æ˜¯å†™å…¥æ—¶ odata[x * M + y] å¹¶ä¸æ˜¯è®¿å­˜åˆå¹¶çš„, å› ä¸ºè½¬ç½®åè¿ç»­çº¿ç¨‹å†™å…¥çš„æ˜¯åŒä¸€åˆ—è¿ç»­çš„è¡Œ, ä½†ç”±äºå†…å­˜å¸ƒå±€æ˜¯è¡Œä¸»åºçš„, å› æ­¤æ­¤æ—¶æ¯ä¸ªçº¿ç¨‹è®¿é—®çš„åœ°å€å®é™…ä¸Šå¹¶ä¸è¿ç»­, åœ°å€å·® N, å› æ­¤å¯¹ GMEM è®¿å­˜æ€§èƒ½æœ‰å¾ˆå¤§å½±å“.</em></p>
<h5>åˆ©ç”¨å…±äº«å†…å­˜åˆå¹¶è®¿å­˜ï¼š {#sector_2}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-k">template </span>&lt;<span class="pl-k">int</span> BLOCK_SZ&gt;
__global__ <span class="pl-k">void</span> <span class="pl-en">mat_transpose_kernel_v1</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">const</span> <span class="pl-k">int</span> bx = blockIdx.<span class="pl-smi">x</span>, by = blockIdx.<span class="pl-smi">y</span>;
    <span class="pl-k">const</span> <span class="pl-k">int</span> tx = threadIdx.<span class="pl-smi">x</span>, ty = threadIdx.<span class="pl-smi">y</span>;

    __shared__ <span class="pl-k">float</span> sdata[BLOCK_SZ][BLOCK_SZ];

    <span class="pl-k">int</span> x = bx * BLOCK_SZ + tx;
    <span class="pl-k">int</span> y = by * BLOCK_SZ + ty;

    <span class="pl-k">if</span> (y &lt; M &amp;&amp; x &lt; N) {
        sdata[ty][tx] = idata[y * N + x];
    }
    <span class="pl-c1">__syncthreads</span>();

    x = by * BLOCK_SZ + tx;
    y = bx * BLOCK_SZ + ty;
    <span class="pl-k">if</span> (y &lt; N &amp;&amp; x &lt; M) {
        odata[y * M + x] = sdata[tx][ty];
    }
}

<span class="pl-k">void</span> <span class="pl-en">mat_transpose_v1</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> BLOCK_SZ = <span class="pl-c1">16</span>;
    dim3 <span class="pl-smi">block</span>(BLOCK_SZ, BLOCK_SZ);
    dim3 <span class="pl-smi">grid</span>(<span class="pl-c1">Ceil</span>(N, BLOCK_SZ), <span class="pl-c1">Ceil</span>(M, BLOCK_SZ));
    mat_transpose_kernel_v1&lt;BLOCK_SZ&gt;&lt;&lt;&lt;grid, block&gt;&gt;&gt;(idata, odata, M, N);
}</pre></div>
<p>åˆ©ç”¨å…±äº«å†…å­˜è¿›è¡Œåˆå¹¶è®¿å­˜æ—¶ï¼Œå®ç°äº†è¯»å‡ºå’Œå†™å…¥æ—¶çš„è®¿å­˜åˆå¹¶ (Memory Coalesce).ä½†æ­¤æ—¶åœ¨å…±äº«å†…å­˜ä¸­ä¼šå‡ºç°ç”±äºè¯»å…¥å’Œå†™å‡ºæ—¶æ•°æ®æ“ä½œä¸ä¸€è‡´å¯¼è‡´çš„ <code class="notranslate">odata[y * M + x] = sdata[tx][ty]; </code> å‡ºç°æ¯ä¸¤è¡Œå‡ºç° Bank Conflict å†²çª,ä»è€Œé€ æˆäº† <strong>16è·¯çš„å†…å­˜å†²çª</strong>ï¼›</p>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/06f4532d9a23c327a3a1405cb2d537c3a7a14fb548dea665a2d5a44272130f82/68747470733a2f2f646576656c6f7065722e6e76696469612e636f6d2f626c6f672f77702d636f6e74656e742f75706c6f6164732f323031322f31312f7368617265645472616e73706f73652d31303234783430392e6a7067"><img src="https://camo.githubusercontent.com/06f4532d9a23c327a3a1405cb2d537c3a7a14fb548dea665a2d5a44272130f82/68747470733a2f2f646576656c6f7065722e6e76696469612e636f6d2f626c6f672f77702d636f6e74656e742f75706c6f6164732f323031322f31312f7368617265645472616e73706f73652d31303234783430392e6a7067" height="200" data-canonical-src="https://developer.nvidia.com/blog/wp-content/uploads/2012/11/sharedTranspose-1024x409.jpg" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>åˆ©ç”¨å…±äº«å†…å­˜è¿›è¡ŒçŸ©é˜µè½¬ç½®</p>
</div>
<blockquote>
<p>Version 1 çš„æ ¸å¿ƒæ€æƒ³å¯ä»¥ä½¿ç”¨ä¸Šå›¾è¿›è¡Œè¡¨ç¤º, ä¸­é—´çš„ "tile" å³å¯ç†è§£ä¸ºå­˜åœ¨ SMEM çš„æ•°æ®åˆ†ç‰‡.<br>
åœ¨è¯»å–çŸ©é˜µé˜¶æ®µ, æ“ä½œä¸ Version 0 ä¸€è‡´, åŒºåˆ«åœ¨äºå°†æ•°æ®ç›´æ¥å†™å…¥ SMEM ä¸­, å¯¹åº”ä¸Šå›¾æ©™è‰²éƒ¨åˆ†. æ¥ç€é€šè¿‡è®¾ç½® x = by * BLOCK_SZ + tx; y = bx * BLOCK_SZ + ty; ä¸¤æ¡è¯­å¥è¿›è¡Œäº†ç´¢å¼•çš„é‡è®¡ç®—, è¿›è¡Œäº†çº¿ç¨‹å—ç´¢å¼• bx å’Œ by äº¤æ¢, å¯¹åº”ä¸Šå›¾å³ä¸Šè§’çš„æ•°æ®åˆ†ç‰‡è½¬ç½®åæˆä¸ºäº†å·¦ä¸‹è§’çš„æ•°æ®åˆ†ç‰‡. ç”±äºæ­¤æ—¶ tx å’Œ ty å¹¶æ²¡æœ‰äº¤æ¢, å› æ­¤æŒ‰ç…§ odata[y * M + x] å†™å…¥ GMEM æ—¶, è®¿å­˜æ˜¯åˆå¹¶çš„, ä½†éœ€è¦è¯»å– SMEM æ—¶ tx ä¸ ty è¿›è¡Œäº¤æ¢, å®ç°æ•°æ®åˆ†ç‰‡å†…çš„è½¬ç½®, å¯¹åº”ä¸Šå›¾ç»¿è‰²éƒ¨åˆ†.</p>
</blockquote>
<h5>åˆ©ç”¨ padding è§£å†³ bank conflictï¼š {#sector_3}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-k">template </span>&lt;<span class="pl-k">int</span> BLOCK_SZ&gt;
__global__ <span class="pl-k">void</span> <span class="pl-en">mat_transpose_kernel_v2</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">const</span> <span class="pl-k">int</span> bx = blockIdx.<span class="pl-smi">x</span>, by = blockIdx.<span class="pl-smi">y</span>;
    <span class="pl-k">const</span> <span class="pl-k">int</span> tx = threadIdx.<span class="pl-smi">x</span>, ty = threadIdx.<span class="pl-smi">y</span>;

    __shared__ <span class="pl-k">float</span> sdata[BLOCK_SZ][BLOCK_SZ+<span class="pl-c1">1</span>];    <span class="pl-c"><span class="pl-c">//</span> padding</span>

    <span class="pl-k">int</span> x = bx * BLOCK_SZ + tx;
    <span class="pl-k">int</span> y = by * BLOCK_SZ + ty;

    <span class="pl-k">if</span> (y &lt; M &amp;&amp; x &lt; N) {
        sdata[ty][tx] = idata[y * N + x];
    }
    <span class="pl-c1">__syncthreads</span>();

    x = by * BLOCK_SZ + tx;
    y = bx * BLOCK_SZ + ty;
    <span class="pl-k">if</span> (y &lt; N &amp;&amp; x &lt; M) {
        odata[y * M + x] = sdata[tx][ty];
    }
}

<span class="pl-k">void</span> <span class="pl-en">mat_transpose_v2</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> BLOCK_SZ = <span class="pl-c1">16</span>;
    dim3 <span class="pl-smi">block</span>(BLOCK_SZ, BLOCK_SZ);
    dim3 <span class="pl-smi">grid</span>(<span class="pl-c1">Ceil</span>(N, BLOCK_SZ), <span class="pl-c1">Ceil</span>(M, BLOCK_SZ));
    mat_transpose_kernel_v2&lt;BLOCK_SZ&gt;&lt;&lt;&lt;grid, block&gt;&gt;&gt;(idata, odata, M, N);
}</pre></div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/4d92203000babcef542881da0cd09da5173436c40189f4569ae063e1885b95e0/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130303730383330332d37303733333831372e706e67"><img src="https://camo.githubusercontent.com/4d92203000babcef542881da0cd09da5173436c40189f4569ae063e1885b95e0/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130303730383330332d37303733333831372e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603100708303-70733817.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>sdata[ty][tx]</p>
</div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/5650b3f20fde297c9d799165303708e9e5fe2839dc27d7b58af62bd191272a9d/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130303931333538342d3335323637393237362e706e67"><img src="https://camo.githubusercontent.com/5650b3f20fde297c9d799165303708e9e5fe2839dc27d7b58af62bd191272a9d/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130303931333538342d3335323637393237362e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603100913584-352679276.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>sdata[tx][ty]</p>
</div>
<blockquote>
<p>Version 2 çš„ä»£ç ç›¸æ¯”äº Version 1 ä»…åœ¨ SMEM å†…å­˜åˆ†é…æ—¶è¿›è¡Œäº†å˜åŠ¨, å°†å¤§å°æ”¹ä¸ºäº† sdata[BLOCK_SZ][BLOCK_SZ+1], å³åˆ—ç»´åº¦ä¸ŠåŠ å…¥äº† 1 å…ƒç´ å¤§å°çš„ padding.<br>
æ­¤æ—¶, å¯¹äºè¯»å– SMEM çš„ sdata[tx][ty], threadIdx å·® 1 çš„çº¿ç¨‹è®¿é—®çš„æ•°æ®å·® BLOCK_SZ+1, å³ 17, ç”±äº 17 ä¸ 32 äº’è´¨, å› æ­¤ä¸ä¼šæœ‰ bank conflict. å€¼å¾—ä¸€æçš„æ˜¯, å¯¹äºå†™å…¥ SMEM çš„ sdata[ty][tx], ç”±äºæœ‰ 1 ä¸ª padding, warp ä¸­ lane 31 ä¸ lane 0 è®¿é—®çš„å…ƒç´ æ°å¥½å·® 31+1=32 ä¸ªå…ƒç´ , ä¼šæœ‰ 1 ä¸ª bank conflict.</p>
</blockquote>
<h5>å¢åŠ æ¯ä¸ªçº¿ç¨‹çš„å¤„ç†å…ƒç´ ä¸ªæ•°ï¼š {#sector_4}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-k">template </span>&lt;<span class="pl-k">int</span> BLOCK_SZ, <span class="pl-k">int</span> NUM_PER_THREAD&gt;
__global__ <span class="pl-k">void</span> <span class="pl-en">mat_transpose_kernel_v3</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">const</span> <span class="pl-k">int</span> bx = blockIdx.<span class="pl-smi">x</span>, by = blockIdx.<span class="pl-smi">y</span>;
    <span class="pl-k">const</span> <span class="pl-k">int</span> tx = threadIdx.<span class="pl-smi">x</span>, ty = threadIdx.<span class="pl-smi">y</span>;

    __shared__ <span class="pl-k">float</span> sdata[BLOCK_SZ][BLOCK_SZ+<span class="pl-c1">1</span>];

    <span class="pl-k">int</span> x = bx * BLOCK_SZ + tx;
    <span class="pl-k">int</span> y = by * BLOCK_SZ + ty;

    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> ROW_STRIDE = BLOCK_SZ / NUM_PER_THREAD;

    <span class="pl-k">if</span> (x &lt; N) {
        #<span class="pl-k">pragma</span> unroll
        <span class="pl-k">for</span> (<span class="pl-k">int</span> y_off = <span class="pl-c1">0</span>; y_off &lt; BLOCK_SZ; y_off += ROW_STRIDE) {
            <span class="pl-k">if</span> (y + y_off &lt; M) {
                sdata[ty + y_off][tx] = idata[(y + y_off) * N + x]; 
            }
        }
    }
    <span class="pl-c1">__syncthreads</span>();

    x = by * BLOCK_SZ + tx;
    y = bx * BLOCK_SZ + ty;
    <span class="pl-k">if</span> (x &lt; M) {
        <span class="pl-k">for</span> (<span class="pl-k">int</span> y_off = <span class="pl-c1">0</span>; y_off &lt; BLOCK_SZ; y_off += ROW_STRIDE) {
            <span class="pl-k">if</span> (y + y_off &lt; N) {
                odata[(y + y_off) * M + x] = sdata[tx][ty + y_off];
            }
        }
    }
}

<span class="pl-k">void</span> <span class="pl-en">mat_transpose_v3</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> BLOCK_SZ = <span class="pl-c1">32</span>;
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> NUM_PER_THREAD = <span class="pl-c1">4</span>;
    dim3 <span class="pl-smi">block</span>(BLOCK_SZ, BLOCK_SZ/NUM_PER_THREAD);
    dim3 <span class="pl-smi">grid</span>(<span class="pl-c1">Ceil</span>(N, BLOCK_SZ), <span class="pl-c1">Ceil</span>(M, BLOCK_SZ));
    mat_transpose_kernel_v3&lt;BLOCK_SZ, NUM_PER_THREAD&gt;&lt;&lt;&lt;grid, block&gt;&gt;&gt;(idata, odata, M, N);
}</pre></div>
<p>å¯¹äºå¢åŠ çº¿ç¨‹è®¡ç®—å…ƒç´ ä¸ªæ•°ï¼Œä½¿ç”¨äº†æ›´å°‘çš„çº¿ç¨‹æ¥è¿›è¡Œè½¬ç½®ä»è€Œæé«˜è®¡ç®—è®¿å­˜æ¯”(å¹¿ä¹‰ä¸Šçš„è®¡ç®—ï¼Œå› ä¸ºçŸ©é˜µè½¬ç½®å®è´¨ä¸Šä¸è¿›è¡Œè®¡ç®—ï¼Œä»…ä»…æ˜¯è®¿å­˜åŠä½ç½®çš„äº’æ¢)ï¼Œå®ç°äº†åœ¨åˆ—ç»´åº¦ä¸Šçš„çº¿ç¨‹æ•°é‡çš„å‡å°‘ã€‚åœ¨è¿™æ—¶ï¼Œsdata[ty + y_off][tx] çš„ bank å®ç°äº†æ— å†²çª (è¿™æ—¶å…¶å®ç”±äºå…±äº«å†…å­˜çš„bankæ˜¯32è·¯ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰å†²çª)ã€‚</p>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/d8d04f8316e66320155787cb87b5f21018217db9669d86e1c9a0bc8fbd83b4ab/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333039353330393139362d313537363735303138372e706e67"><img src="https://camo.githubusercontent.com/d8d04f8316e66320155787cb87b5f21018217db9669d86e1c9a0bc8fbd83b4ab/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333039353330393139362d313537363735303138372e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603095309196-1576750187.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>sdata[ty + y_off][tx]</p>
</div>
<p>è€Œåœ¨sdata[tx][ty + y_off] ä¸­ï¼Œç”±äºäº¤é”™æ’åˆ—ï¼Œä¹Ÿé¿å…äº†å†…å­˜å†²çªã€‚</p>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f1628f745c1ef20513d162452eaf93f440212f1335e1f340c6774f7dc9fee125/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333039353633303439362d313735363331333336312e706e67"><img src="https://camo.githubusercontent.com/f1628f745c1ef20513d162452eaf93f440212f1335e1f340c6774f7dc9fee125/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333039353633303439362d313735363331333336312e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603095630496-1756313361.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>sdata[tx][ty + y_off]</p>
</div>
<blockquote>
<p>Version 3 ç›¸æ¯”äº Version 2, å¢åŠ äº†æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ ä¸ªæ•°, å³ç”±å…ˆå‰çš„æ¯ä¸ªçº¿ç¨‹å¤„ç† 1 ä¸ªå…ƒç´ çš„è½¬ç½®, å˜ä¸ºå¤„ç† NUM_PER_THREAD ä¸ªå…ƒç´ çš„è½¬ç½®. è¯¥å®ç°ä¸»è¦æ˜¯å‚è€ƒäº† è‹±ä¼Ÿè¾¾çš„æŠ€æœ¯åšå®¢.<br>
åœ¨å®ç°ä¸Š, åŒæ ·ä¿æŒåŸæœ¬ 256 çº¿ç¨‹çš„çº¿ç¨‹å—å¤§å°, è®¾ç½®æ¯ä¸ªçº¿ç¨‹å¤„ç† 4 ä¸ªå…ƒç´ , åˆ™æ¯ä¸ªçº¿ç¨‹å—æ•°æ®åˆ†ç‰‡çš„å¤§å°è°ƒæ•´ä¸º 32Ã—32, è€Œçº¿ç¨‹å—çš„çº¿ç¨‹é‡‡å– 8Ã—32 çš„äºŒç»´æ’å¸ƒ, å› æ­¤éœ€è¦åœ¨è¡Œç»´åº¦ä¸Šéœ€è¦è¿­ä»£ 4 æ¬¡å®Œæˆè½¬ç½®.<br>
è€ƒè™‘ Version 3 ç›¸æ¯”äº Version 2 çš„ä¼˜åŠ¿, ä¸»è¦æ˜¯åœ¨ä¿æŒçº¿ç¨‹å—ä¸­çº¿ç¨‹æ•°é‡ä¸å˜çš„æƒ…å†µä¸‹, å¤„ç†çš„çº¿ç¨‹å—æ•°æ®åˆ†ç‰‡å¤§å°å˜å¤§, è¿™æ ·ä¼šå‡å°‘çº¿ç¨‹ç½‘æ ¼ä¸­å¯åŠ¨çš„çº¿ç¨‹å—æ•°é‡, è€Œå¢å¤§äº†æ¯ä¸ªçº¿ç¨‹çš„è®¡ç®—å¼ºåº¦; æ­¤å¤–, ç”±äº BLOCK_SZ å˜ä¸º 32, Version 2 ä¸­å†™å…¥ SMEM çš„ 1 ä¸ª bank conflict ä¹Ÿå¯ä»¥è¢«é¿å….<br>
è¿™è®©ç¬”è€…æƒ³åˆ°äº† Reduce ç®—å­ä¸­ä¹Ÿä¼šè€ƒè™‘å¢åŠ æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ¥æé«˜æ€§èƒ½, ç¬”è€…ä¸»è§‚çš„æ„Ÿè§‰æ˜¯å¯¹äºè¿™ç§è®¡ç®—å¼ºåº¦æ¯”è¾ƒä½çš„ kernel, å¢åŠ çº¿ç¨‹å¤„ç†çš„å…ƒç´ ä¸ªæ•°å³è®¡ç®—å¼ºåº¦, ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¢å¤§ GPU ä¸­è®¡ç®—ä¸è®¿å­˜çš„æ©ç›–, å¹¶é…åˆå¾ªç¯å±•å¼€æé«˜æŒ‡ä»¤çº§å¹¶è¡Œ; æ­¤å¤–, ç”±äºçº¿ç¨‹å—æ•°é‡çš„å‡å°‘, èƒ½åœ¨ç›¸å¯¹å°‘çš„ wave ä¸­å®Œæˆè®¡ç®—, å‡å°‘ GPU çš„çº¿ç¨‹å—è°ƒåº¦ä¸Šå¯èƒ½ä¹Ÿä¼šå¸¦æ¥æ€§èƒ½çš„æ”¶ç›Š.</p>
</blockquote>
<h5>å‘é‡åŒ–å­˜å–ï¼š {#sector_5}</h5>
<p>å‘é‡åŒ–å­˜å–çš„å…³é”®åœ¨äº</p>
<div class="highlight highlight-source-c++"><pre class="notranslate">#<span class="pl-k">define</span> <span class="pl-en">FETCH_CFLOAT4</span>(<span class="pl-v">p</span>) (<span class="pl-k">reinterpret_cast</span>&lt;<span class="pl-k">const</span> float4*&gt;(&amp;(p))[<span class="pl-c1">0</span>])
#<span class="pl-k">define</span> <span class="pl-en">FETCH_FLOAT4</span>(<span class="pl-v">p</span>) (<span class="pl-k">reinterpret_cast</span>&lt;float4*&gt;(&amp;(p))[<span class="pl-c1">0</span>])</pre></div>
<p>è¿™ä¸¤å¥ä»£ç å®ç°äº†ä½¿ç”¨FETCH_FLOAT4å’ŒFETCH_CFLOAT4ä¸€æ¬¡æ€§è¯»å–å’Œå­˜å‚¨4ä¸ªæµ®ç‚¹æ•°ã€‚å°†æŒ‡é’ˆpå¼ºåˆ¶è½¬æ¢ä¸ºconst float4<em>å’Œfloat4</em>ç±»å‹ï¼Œå¹¶è·å–ç¬¬ä¸€ä¸ªfloat4ç±»å‹çš„å€¼ã€‚float4æ˜¯ä¸€ä¸ªåŒ…å«4ä¸ªæµ®ç‚¹æ•°çš„CUDAå†…ç½®å‘é‡ç±»å‹ï¼Œè¿™ç§è½¬æ¢å¯ä»¥ä¸€æ¬¡æ€§å¤„ç†4ä¸ªæµ®ç‚¹æ•°ï¼Œä»è€Œæé«˜å†…å­˜è®¿é—®çš„æ•ˆç‡ã€‚</p>
<div class="highlight highlight-source-c++"><pre class="notranslate">#<span class="pl-k">define</span> <span class="pl-en">FETCH_CFLOAT4</span>(<span class="pl-v">p</span>) (<span class="pl-k">reinterpret_cast</span>&lt;<span class="pl-k">const</span> float4*&gt;(&amp;(p))[<span class="pl-c1">0</span>])
#<span class="pl-k">define</span> <span class="pl-en">FETCH_FLOAT4</span>(<span class="pl-v">p</span>) (<span class="pl-k">reinterpret_cast</span>&lt;float4*&gt;(&amp;(p))[<span class="pl-c1">0</span>])

<span class="pl-k">template </span>&lt;<span class="pl-k">int</span> BLOCK_SZ&gt;
__global__ <span class="pl-k">void</span> <span class="pl-en">mat_transpose_kernel_v3_5</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">const</span> <span class="pl-k">int</span> bx = blockIdx.<span class="pl-smi">x</span>, by = blockIdx.<span class="pl-smi">y</span>;
    <span class="pl-k">const</span> <span class="pl-k">int</span> tx = threadIdx.<span class="pl-smi">x</span>, ty = threadIdx.<span class="pl-smi">y</span>;

    __shared__ <span class="pl-k">float</span> sdata[BLOCK_SZ][BLOCK_SZ];

    <span class="pl-k">int</span> x = bx * BLOCK_SZ + tx * <span class="pl-c1">4</span>;
    <span class="pl-k">int</span> y = by * BLOCK_SZ + ty;

    <span class="pl-k">if</span> (x &lt; N &amp;&amp; y &lt; M) {
        <span class="pl-c1">FETCH_FLOAT4</span>(sdata[ty][tx * <span class="pl-c1">4</span>]) = <span class="pl-c1">FETCH_CFLOAT4</span>(idata[y * N + x]);
    }
    <span class="pl-c1">__syncthreads</span>();

    x = by * BLOCK_SZ + tx * <span class="pl-c1">4</span>;
    y = bx * BLOCK_SZ + ty;
    <span class="pl-k">float</span> tmp[<span class="pl-c1">4</span>];
    <span class="pl-k">if</span> (x &lt; M &amp;&amp; y &lt; N) {
        #<span class="pl-k">pragma</span> unroll
        <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">4</span>; ++i) {
            tmp[i] = sdata[tx * <span class="pl-c1">4</span> + i][ty];
        }
        <span class="pl-c1">FETCH_FLOAT4</span>(odata[y * M + x]) = <span class="pl-c1">FETCH_FLOAT4</span>(tmp);
    }
}

<span class="pl-k">void</span> <span class="pl-en">mat_transpose_v3_5</span>(<span class="pl-k">const</span> <span class="pl-k">float</span>* idata, <span class="pl-k">float</span>* odata, <span class="pl-k">int</span> M, <span class="pl-k">int</span> N) {
    <span class="pl-k">constexpr</span> <span class="pl-k">int</span> BLOCK_SZ = <span class="pl-c1">32</span>;
    dim3 <span class="pl-smi">block</span>(BLOCK_SZ / <span class="pl-c1">4</span>, BLOCK_SZ);
    dim3 <span class="pl-smi">grid</span>(<span class="pl-c1">Ceil</span>(N, BLOCK_SZ), <span class="pl-c1">Ceil</span>(M, BLOCK_SZ));
    mat_transpose_kernel_v3_5&lt;BLOCK_SZ&gt;&lt;&lt;&lt;grid, block&gt;&gt;&gt;(idata, odata, M, N);
}</pre></div>
<p>æ­¤æ—¶åˆ©ç”¨å‘é‡åŒ–è®¿å­˜çš„æ•ˆç‡æ˜¯æ¯”å•çº¯åˆ©ç”¨å…±äº«å†…å­˜é«˜çš„ï¼Œä½†æ˜¯ç”±äºæ— æ³•é¿å…bank conflictï¼Œè¿è¡Œæ—¶é—´è¿˜æ˜¯æœ‰è¾ƒå¤§å»¶è¿Ÿã€‚</p>
<hr>
<h4>çŸ©é˜µè½¬ç½®ç»¼åˆåº”ç”¨ï¼š {#chapter_2}</h4>
<h5>Floatæ•°æ®ç±»å‹è½¬ç½®ï¼š {#float}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-c"><span class="pl-c">/*</span> Copyright (c) 1993-2015, NVIDIA CORPORATION. All rights reserved.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * Redistribution and use in source and binary forms, with or without</span>
<span class="pl-c"> * modification, are permitted provided that the following conditions</span>
<span class="pl-c"> * are met:</span>
<span class="pl-c"> *  * Redistributions of source code must retain the above copyright</span>
<span class="pl-c"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="pl-c"> *  * Redistributions in binary form must reproduce the above copyright</span>
<span class="pl-c"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="pl-c"> *    documentation and/or other materials provided with the distribution.</span>
<span class="pl-c"> *  * Neither the name of NVIDIA CORPORATION nor the names of its</span>
<span class="pl-c"> *    contributors may be used to endorse or promote products derived</span>
<span class="pl-c"> *    from this software without specific prior written permission.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY</span>
<span class="pl-c"> * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="pl-c"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="pl-c"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<span class="pl-c"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="pl-c"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="pl-c"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="pl-c"> * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY</span>
<span class="pl-c"> * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="pl-c"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="pl-c"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="pl-c"> <span class="pl-c">*/</span></span>

#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span>
#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>assert.h<span class="pl-pds">&gt;</span></span>

<span class="pl-c"><span class="pl-c">//</span> æ–¹ä¾¿çš„CUDAè¿è¡Œæ—¶APIç»“æœæ£€æŸ¥å‡½æ•°</span>
<span class="pl-c"><span class="pl-c">//</span> å¯ä»¥åŒ…è£…ä»»ä½•è¿è¡Œæ—¶APIè°ƒç”¨ã€‚åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­æ— æ“ä½œã€‚</span>
<span class="pl-k">inline</span> 
cudaError_t <span class="pl-en">checkCuda</span>(cudaError_t result)
{
#<span class="pl-k">if</span> defined(DEBUG) || defined(_DEBUG)
  <span class="pl-k">if</span> (result != cudaSuccess) {
    <span class="pl-c1">fprintf</span>(stderr, <span class="pl-s"><span class="pl-pds">"</span>CUDA Runtime Error: %s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">cudaGetErrorString</span>(result));
    <span class="pl-c1">assert</span>(result == cudaSuccess);
  }
#<span class="pl-k">endif</span>
  <span class="pl-k">return</span> result;
}

<span class="pl-k">const</span> <span class="pl-k">int</span> TILE_DIM = <span class="pl-c1">32</span>;
<span class="pl-k">const</span> <span class="pl-k">int</span> BLOCK_ROWS = <span class="pl-c1">8</span>;
<span class="pl-c"><span class="pl-c">//</span> å†…æ ¸é‡å¤æ‰§è¡Œæ¬¡æ•°</span>
<span class="pl-k">const</span> <span class="pl-k">int</span> NUM_REPS = <span class="pl-c1">5</span>;

<span class="pl-c"><span class="pl-c">//</span> æ£€æŸ¥é”™è¯¯å¹¶æ‰“å°GB/s</span>
<span class="pl-k">void</span> <span class="pl-en">postprocess</span>(<span class="pl-k">const</span> <span class="pl-k">float</span> *ref, <span class="pl-k">const</span> <span class="pl-k">float</span> *res, <span class="pl-k">int</span> n, <span class="pl-k">float</span> ms)
{
  <span class="pl-k">bool</span> passed = <span class="pl-c1">true</span>;
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; n; i++)
    <span class="pl-k">if</span> (res[i] != ref[i]) {
      <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%d %f %f<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, res[i], ref[i]);
      <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>*** FAILED ***<span class="pl-pds">"</span></span>);
      passed = <span class="pl-c1">false</span>;
      <span class="pl-k">break</span>;
    }
  <span class="pl-k">if</span> (passed)
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%20.2f<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">2</span> * n * <span class="pl-k">sizeof</span>(<span class="pl-k">float</span>) * <span class="pl-c1">1e-6</span> * NUM_REPS / ms );
}

<span class="pl-c"><span class="pl-c">//</span> ç®€å•å¤åˆ¶å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä½œä¸ºåŸºå‡†æ¡ˆä¾‹ï¼Œè¡¨ç¤ºæœ€ä½³æœ‰æ•ˆå¸¦å®½ã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">copy</span>(<span class="pl-k">float</span> *odata, <span class="pl-k">const</span> <span class="pl-k">float</span> *idata)
{
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j+= BLOCK_ROWS)
    odata[(y+j)*width + x] = idata[(y+j)*width + x];
}

<span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜çš„å¤åˆ¶å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä¹Ÿæ˜¯åŸºå‡†æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†ä½¿ç”¨å…±äº«å†…å­˜çš„æ•ˆæœã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">copySharedMem</span>(<span class="pl-k">float</span> *odata, <span class="pl-k">const</span> <span class="pl-k">float</span> *idata)
{
  __shared__ <span class="pl-k">float</span> tile[TILE_DIM * TILE_DIM];
  
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[(threadIdx.<span class="pl-smi">y</span>+j)*TILE_DIM + threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[(threadIdx.<span class="pl-smi">y</span>+j)*TILE_DIM + threadIdx.<span class="pl-smi">x</span>];          
}

<span class="pl-c"><span class="pl-c">//</span> ç®€å•è½¬ç½®</span>
<span class="pl-c"><span class="pl-c">//</span> æœ€ç®€å•çš„è½¬ç½®ï¼›ä¸ä½¿ç”¨å…±äº«å†…å­˜ã€‚</span>
<span class="pl-c"><span class="pl-c">//</span> å…¨å±€å†…å­˜è¯»å–æ˜¯åˆå¹¶çš„ï¼Œä½†å†™å…¥ä¸æ˜¯ã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeNaive</span>(<span class="pl-k">float</span> *odata, <span class="pl-k">const</span> <span class="pl-k">float</span> *idata)
{
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j+= BLOCK_ROWS)
    odata[x*width + (y+j)] = idata[(y+j)*width + x];
}

<span class="pl-c"><span class="pl-c">//</span> åˆå¹¶è½¬ç½®</span>
<span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜æ¥å®ç°è¯»å–å’Œå†™å…¥çš„åˆå¹¶</span>
<span class="pl-c"><span class="pl-c">//</span> tileå®½åº¦==bankæ•°é‡ä¼šå¯¼è‡´å…±äº«å†…å­˜bankå†²çªã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeCoalesced</span>(<span class="pl-k">float</span> *odata, <span class="pl-k">const</span> <span class="pl-k">float</span> *idata)
{
  __shared__ <span class="pl-k">float</span> tile[TILE_DIM][TILE_DIM];
    
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[threadIdx.<span class="pl-smi">y</span>+j][threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  x = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;  <span class="pl-c"><span class="pl-c">//</span> è½¬ç½®å—åç§»</span>
  y = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[threadIdx.<span class="pl-smi">x</span>][threadIdx.<span class="pl-smi">y</span> + j];
}

<span class="pl-c"><span class="pl-c">//</span> æ— bankå†²çªè½¬ç½®</span>
<span class="pl-c"><span class="pl-c">//</span> ä¸transposeCoalescedç›¸åŒï¼Œåªæ˜¯ç¬¬ä¸€ä¸ªtileç»´åº¦å¡«å……</span>
<span class="pl-c"><span class="pl-c">//</span> ä»¥é¿å…å…±äº«å†…å­˜bankå†²çªã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeNoBankConflicts</span>(<span class="pl-k">float</span> *odata, <span class="pl-k">const</span> <span class="pl-k">float</span> *idata)
{
  __shared__ <span class="pl-k">float</span> tile[TILE_DIM][TILE_DIM+<span class="pl-c1">1</span>];
    
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[threadIdx.<span class="pl-smi">y</span>+j][threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  x = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;  <span class="pl-c"><span class="pl-c">//</span> è½¬ç½®å—åç§»</span>
  y = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[threadIdx.<span class="pl-smi">x</span>][threadIdx.<span class="pl-smi">y</span> + j];
}

<span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> **argv)
{
  <span class="pl-k">const</span> <span class="pl-k">int</span> nx = <span class="pl-c1">2048</span>;
  <span class="pl-k">const</span> <span class="pl-k">int</span> ny = <span class="pl-c1">2048</span>;
  <span class="pl-k">const</span> <span class="pl-k">int</span> mem_size = nx*ny*<span class="pl-k">sizeof</span>(<span class="pl-k">float</span>);

  dim3 <span class="pl-smi">dimGrid</span>(nx/TILE_DIM, ny/TILE_DIM, <span class="pl-c1">1</span>);
  dim3 <span class="pl-smi">dimBlock</span>(TILE_DIM, BLOCK_ROWS, <span class="pl-c1">1</span>);

  <span class="pl-k">int</span> devId = <span class="pl-c1">0</span>;
  <span class="pl-k">if</span> (argc &gt; <span class="pl-c1">1</span>) devId = <span class="pl-c1">atoi</span>(argv[<span class="pl-c1">1</span>]);

  cudaDeviceProp prop;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaGetDeviceProperties</span>(&amp;prop, devId));
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span>Device : %s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, prop.<span class="pl-smi">name</span>);
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Matrix size: %d %d, Block size: %d %d, Tile size: %d %d<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, 
         nx, ny, TILE_DIM, BLOCK_ROWS, TILE_DIM, TILE_DIM);
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>dimGrid: %d %d %d. dimBlock: %d %d %d<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
         dimGrid.<span class="pl-smi">x</span>, dimGrid.<span class="pl-smi">y</span>, dimGrid.<span class="pl-smi">z</span>, dimBlock.<span class="pl-smi">x</span>, dimBlock.<span class="pl-smi">y</span>, dimBlock.<span class="pl-smi">z</span>);
  
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaSetDevice</span>(devId) );

  <span class="pl-k">float</span> *h_idata = (<span class="pl-k">float</span>*)<span class="pl-c1">malloc</span>(mem_size);
  <span class="pl-k">float</span> *h_cdata = (<span class="pl-k">float</span>*)<span class="pl-c1">malloc</span>(mem_size);
  <span class="pl-k">float</span> *h_tdata = (<span class="pl-k">float</span>*)<span class="pl-c1">malloc</span>(mem_size);
  <span class="pl-k">float</span> *gold    = (<span class="pl-k">float</span>*)<span class="pl-c1">malloc</span>(mem_size);
  
  <span class="pl-k">float</span> *d_idata, *d_cdata, *d_tdata;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_idata, mem_size) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_cdata, mem_size) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_tdata, mem_size) );

  <span class="pl-c"><span class="pl-c">//</span> æ£€æŸ¥å‚æ•°å¹¶è®¡ç®—æ‰§è¡Œé…ç½®</span>
  <span class="pl-k">if</span> (nx % TILE_DIM || ny % TILE_DIM) {
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>nx å’Œ ny å¿…é¡»æ˜¯ TILE_DIM çš„å€æ•°<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
    <span class="pl-k">goto</span> error_exit;
  }

  <span class="pl-k">if</span> (TILE_DIM % BLOCK_ROWS) {
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>TILE_DIM å¿…é¡»æ˜¯ BLOCK_ROWS çš„å€æ•°<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
    <span class="pl-k">goto</span> error_exit;
  }
    
  <span class="pl-c"><span class="pl-c">//</span> ä¸»æœº</span>
  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; ny; j++)
    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nx; i++)
      h_idata[j*nx + i] = j*nx + i;

  <span class="pl-c"><span class="pl-c">//</span> ç”¨äºé”™è¯¯æ£€æŸ¥çš„æ­£ç¡®ç»“æœ</span>
  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; ny; j++)
    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nx; i++)
      gold[j*nx + i] = h_idata[i*nx + j];
  
  <span class="pl-c"><span class="pl-c">//</span> è®¾å¤‡</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(d_idata, h_idata, mem_size, cudaMemcpyHostToDevice) );
  
  <span class="pl-c"><span class="pl-c">//</span> ç”¨äºè®¡æ—¶çš„äº‹ä»¶</span>
  cudaEvent_t startEvent, stopEvent;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventCreate</span>(&amp;startEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventCreate</span>(&amp;stopEvent) );
  <span class="pl-k">float</span> ms;

  <span class="pl-c"><span class="pl-c">//</span> ------------</span>
  <span class="pl-c"><span class="pl-c">//</span> å†…æ ¸è®¡æ—¶</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s%25s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Routine<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Bandwidth (GB/s)<span class="pl-pds">"</span></span>);
  
  <span class="pl-c"><span class="pl-c">//</span> ----</span>
  <span class="pl-c"><span class="pl-c">//</span> å¤åˆ¶</span>
  <span class="pl-c"><span class="pl-c">//</span> ----</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>copy<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_cdata, <span class="pl-c1">0</span>, mem_size) );
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  copy&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     copy&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_cdata, d_cdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(h_idata, h_cdata, nx*ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> -------------</span>
  <span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜çš„å¤åˆ¶</span>
  <span class="pl-c"><span class="pl-c">//</span> -------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>shared memory copy<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_cdata, <span class="pl-c1">0</span>, mem_size) );
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  copySharedMem&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     copySharedMem&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_cdata, d_cdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(h_idata, h_cdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> --------------</span>
  <span class="pl-c"><span class="pl-c">//</span> ç®€å•è½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> --------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>naive transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeNaive&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeNaive&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> ------------------</span>
  <span class="pl-c"><span class="pl-c">//</span> åˆå¹¶è½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>coalesced transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeCoalesced&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeCoalesced&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> ------------------------</span>
  <span class="pl-c"><span class="pl-c">//</span> æ— bankå†²çªè½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>conflict-free transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeNoBankConflicts&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeNoBankConflicts&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

error_exit:
  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç†</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventDestroy</span>(startEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventDestroy</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_tdata) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_cdata) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_idata) );
  <span class="pl-c1">free</span>(h_idata);
  <span class="pl-c1">free</span>(h_tdata);
  <span class="pl-c1">free</span>(h_cdata);
  <span class="pl-c1">free</span>(gold);
}</pre></div>
<p>ä¸Šè¿°ç¨‹åºå‚è€ƒäº†NIVIDAå®˜æ–¹ç¤¾åŒºç¤ºä¾‹ç¨‹åºå¹¶åŠ ä»¥è¡¥å……å®Œå–„ï¼ŒåŸºæœ¬å®ç°äº†å®Œæ•´çš„CUDAç¨‹åºçš„ç¼–å†™è¿‡ç¨‹ï¼Œä¸”ç¨‹åºä¸­æ¯ä¸ªçº¿ç¨‹éƒ½è·¨åˆ—æ‰§è¡Œ4ä¸ªæ•°æ®çš„æ‰§è¡Œã€‚ç¨‹åºä¸­é¦–å…ˆå®šä¹‰checkCudaæ ‡å‡†é”™è¯¯å‡½æ•°ä»¥åŠç»“æœæ£€éªŒå’Œå¸¦å®½è®¡ç®—postprocesså‡½æ•°ï¼Œæ¥ç€å®šä¹‰copyå’ŒcopySharedMemä¸¤ä¸ªåŸºå‡†ç¨‹åºä»¥ä½œä¸ºä¸ä½¿ç”¨/ä½¿ç”¨Shared Memoryä¸‹çš„æœ€å¤§å¸¦å®½ã€‚</p>
<div class="markdown-alert markdown-alert-tip"><p class="markdown-alert-title"><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p><p>åœ¨è½¬ç½®çš„å®ç°ä¸­ï¼ŒtransposeNaiveå‡½æ•°åˆ©ç”¨Global Memoryå®ç°äº†åŸºæœ¬çš„è½¬ç½®æ“ä½œï¼Œä½†ç”±äºè½¬ç½®æ“ä½œç‰¹æ€§ï¼Œå¯¼è‡´å…¶åªåœ¨è¯»å–çŸ©é˜µæ—¶å®ç°äº†åˆå¹¶è®¿å­˜ï¼Œåœ¨å†™å…¥æ—¶å¹¶æ²¡æœ‰å®ç°ã€‚åœ¨transposeCoalescedå‡½æ•°ä¸­ï¼Œåˆ©ç”¨Shared Memoryå®ç°äº†å¯¹äºå…¨å±€å†…å­˜è¯»å–ä»¥åŠå†™å…¥çš„è®¿å­˜åˆå¹¶ï¼Œä½†åœ¨å…±äº«å†…å­˜çš„è¯»å–æ—¶ç”±äºè½¬ç½®æ“ä½œç‰¹æ€§ï¼Œå¯¼è‡´äº†bank conflictçš„å‡ºç°ã€‚æœ€ååœ¨transposeNoBankConflictsç¨‹åºä¸­ï¼Œé€šè¿‡å¼•å…¥paddingï¼Œè§£å†³äº†å†…å­˜å†²çªçš„é—®é¢˜ã€‚</p>
</div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/3e2a1b7d3cb7b36a99dbbd520cb5f46d12883a1cdd6a50a59437bc1bc4b5061d/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130323432363433342d313636373234363136352e706e67"><img src="https://camo.githubusercontent.com/3e2a1b7d3cb7b36a99dbbd520cb5f46d12883a1cdd6a50a59437bc1bc4b5061d/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130323432363433342d313636373234363136352e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603102426434-1667246165.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>è¿è¡Œç»“æœ</p>
</div>
<h5>Doubleæ•°æ®ç±»å‹è½¬ç½®ï¼š {#double}</h5>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-c"><span class="pl-c">/*</span> Copyright (c) 1993-2015, NVIDIA CORPORATION. All rights reserved.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * Redistribution and use in source and binary forms, with or without</span>
<span class="pl-c"> * modification, are permitted provided that the following conditions</span>
<span class="pl-c"> * are met:</span>
<span class="pl-c"> *  * Redistributions of source code must retain the above copyright</span>
<span class="pl-c"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="pl-c"> *  * Redistributions in binary form must reproduce the above copyright</span>
<span class="pl-c"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="pl-c"> *    documentation and/or other materials provided with the distribution.</span>
<span class="pl-c"> *  * Neither the name of NVIDIA CORPORATION nor the names of its</span>
<span class="pl-c"> *    contributors may be used to endorse or promote products derived</span>
<span class="pl-c"> *    from this software without specific prior written permission.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY</span>
<span class="pl-c"> * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="pl-c"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="pl-c"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<span class="pl-c"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="pl-c"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="pl-c"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="pl-c"> * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY</span>
<span class="pl-c"> * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="pl-c"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="pl-c"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="pl-c"> <span class="pl-c">*/</span></span>

#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span>
#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>assert.h<span class="pl-pds">&gt;</span></span>

<span class="pl-c"><span class="pl-c">//</span> æ–¹ä¾¿çš„CUDAè¿è¡Œæ—¶APIç»“æœæ£€æŸ¥å‡½æ•°</span>
<span class="pl-c"><span class="pl-c">//</span> å¯ä»¥åŒ…è£…ä»»ä½•è¿è¡Œæ—¶APIè°ƒç”¨ã€‚åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­æ— æ“ä½œã€‚</span>
<span class="pl-k">inline</span>
cudaError_t <span class="pl-en">checkCuda</span>(cudaError_t result)
{
#<span class="pl-k">if</span> defined(DEBUG) || defined(_DEBUG)
  <span class="pl-k">if</span> (result != cudaSuccess) {
    <span class="pl-c1">fprintf</span>(stderr, <span class="pl-s"><span class="pl-pds">"</span>CUDA Runtime Error: %s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">cudaGetErrorString</span>(result));
    <span class="pl-c1">assert</span>(result == cudaSuccess);
  }
#<span class="pl-k">endif</span>
  <span class="pl-k">return</span> result;
}

<span class="pl-c"><span class="pl-c">//</span> å®šä¹‰å¸¸é‡</span>
<span class="pl-k">const</span> <span class="pl-k">int</span> TILE_DIM = <span class="pl-c1">32</span>;  <span class="pl-c"><span class="pl-c">//</span> tileç»´åº¦</span>
<span class="pl-k">const</span> <span class="pl-k">int</span> BLOCK_ROWS = <span class="pl-c1">8</span>;  <span class="pl-c"><span class="pl-c">//</span> å—è¡Œæ•°</span>
<span class="pl-k">const</span> <span class="pl-k">int</span> NUM_REPS = <span class="pl-c1">5</span>;  <span class="pl-c"><span class="pl-c">//</span> å†…æ ¸é‡å¤æ‰§è¡Œæ¬¡æ•°</span>

<span class="pl-c"><span class="pl-c">//</span> æ£€æŸ¥é”™è¯¯å¹¶æ‰“å°GB/s</span>
<span class="pl-k">void</span> <span class="pl-en">postprocess</span>(<span class="pl-k">const</span> <span class="pl-k">double</span> *ref, <span class="pl-k">const</span> <span class="pl-k">double</span> *res, <span class="pl-k">int</span> n, <span class="pl-k">double</span> ms)
{
  <span class="pl-k">bool</span> passed = <span class="pl-c1">true</span>;
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; n; i++)
    <span class="pl-k">if</span> (res[i] != ref[i]) {
      <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%d %f %f<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, res[i], ref[i]);
      <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>*** FAILED ***<span class="pl-pds">"</span></span>);
      passed = <span class="pl-c1">false</span>;
      <span class="pl-k">break</span>;
    }
  <span class="pl-k">if</span> (passed)
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%20.2f<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">2</span> * n * <span class="pl-k">sizeof</span>(<span class="pl-k">double</span>) * <span class="pl-c1">1e-6</span> * NUM_REPS / ms );
}

<span class="pl-c"><span class="pl-c">//</span> ç®€å•å¤åˆ¶å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä½œä¸ºåŸºå‡†æ¡ˆä¾‹ï¼Œè¡¨ç¤ºæœ€ä½³æœ‰æ•ˆå¸¦å®½ã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">copy</span>(<span class="pl-k">double</span> *odata, <span class="pl-k">const</span> <span class="pl-k">double</span> *idata)
{
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j+= BLOCK_ROWS)
    odata[(y+j)*width + x] = idata[(y+j)*width + x];
}

<span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜çš„å¤åˆ¶å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä¹Ÿæ˜¯åŸºå‡†æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†ä½¿ç”¨å…±äº«å†…å­˜çš„æ•ˆæœã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">copySharedMem</span>(<span class="pl-k">double</span> *odata, <span class="pl-k">const</span> <span class="pl-k">double</span> *idata)
{
  __shared__ <span class="pl-k">double</span> tile[TILE_DIM * TILE_DIM];
  
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[(threadIdx.<span class="pl-smi">y</span>+j)*TILE_DIM + threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[(threadIdx.<span class="pl-smi">y</span>+j)*TILE_DIM + threadIdx.<span class="pl-smi">x</span>];          
}

<span class="pl-c"><span class="pl-c">//</span> ç®€å•è½¬ç½®å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> æœ€ç®€å•çš„è½¬ç½®ï¼›ä¸ä½¿ç”¨å…±äº«å†…å­˜ã€‚</span>
<span class="pl-c"><span class="pl-c">//</span> å…¨å±€å†…å­˜è¯»å–æ˜¯åˆå¹¶çš„ï¼Œä½†å†™å…¥ä¸æ˜¯ã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeNaive</span>(<span class="pl-k">double</span> *odata, <span class="pl-k">const</span> <span class="pl-k">double</span> *idata)
{
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j+= BLOCK_ROWS)
    odata[x*width + (y+j)] = idata[(y+j)*width + x];
}

<span class="pl-c"><span class="pl-c">//</span> åˆå¹¶è½¬ç½®å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜æ¥å®ç°è¯»å–å’Œå†™å…¥çš„åˆå¹¶</span>
<span class="pl-c"><span class="pl-c">//</span> tileå®½åº¦==ban kæ•°é‡ä¼šå¯¼è‡´å…±äº«å†…å­˜bankå†²çªã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeCoalesced</span>(<span class="pl-k">double</span> *odata, <span class="pl-k">const</span> <span class="pl-k">double</span> *idata)
{
  __shared__ <span class="pl-k">double</span> tile[TILE_DIM][TILE_DIM];
    
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[threadIdx.<span class="pl-smi">y</span>+j][threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  x = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;  <span class="pl-c"><span class="pl-c">//</span> è½¬ç½®å—åç§»</span>
  y = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[threadIdx.<span class="pl-smi">x</span>][threadIdx.<span class="pl-smi">y</span> + j];
}

<span class="pl-c"><span class="pl-c">//</span> æ— bankå†²çªè½¬ç½®å†…æ ¸</span>
<span class="pl-c"><span class="pl-c">//</span> ä¸transposeCoalescedç›¸åŒï¼Œåªæ˜¯ç¬¬ä¸€ä¸ªti leç»´åº¦å¡«å……</span>
<span class="pl-c"><span class="pl-c">//</span> ä»¥é¿å…å…±äº«å†…å­˜bankå†²çªã€‚</span>
__global__ <span class="pl-k">void</span> <span class="pl-en">transposeNoBankConflicts</span>(<span class="pl-k">double</span> *odata, <span class="pl-k">const</span> <span class="pl-k">double</span> *idata)
{
  __shared__ <span class="pl-k">double</span> tile[TILE_DIM][TILE_DIM+<span class="pl-c1">1</span>];
    
  <span class="pl-k">int</span> x = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;
  <span class="pl-k">int</span> y = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;
  <span class="pl-k">int</span> width = gridDim.<span class="pl-smi">x</span> * TILE_DIM;

  <span class="pl-c"><span class="pl-c">//</span> å·å¸˜æ–¹å¼å­˜å–</span>
  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     tile[threadIdx.<span class="pl-smi">y</span>+j][threadIdx.<span class="pl-smi">x</span>] = idata[(y+j)*width + x];

  <span class="pl-c1">__syncthreads</span>();

  x = blockIdx.<span class="pl-smi">y</span> * TILE_DIM + threadIdx.<span class="pl-smi">x</span>;  <span class="pl-c"><span class="pl-c">//</span> è½¬ç½®å—åç§»</span>
  y = blockIdx.<span class="pl-smi">x</span> * TILE_DIM + threadIdx.<span class="pl-smi">y</span>;

  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; TILE_DIM; j += BLOCK_ROWS)
     odata[(y+j)*width + x] = tile[threadIdx.<span class="pl-smi">x</span>][threadIdx.<span class="pl-smi">y</span> + j];
}

<span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> **argv)
{
  <span class="pl-k">const</span> <span class="pl-k">int</span> nx = <span class="pl-c1">2048</span>;  <span class="pl-c"><span class="pl-c">//</span> çŸ©é˜µçš„xç»´åº¦</span>
  <span class="pl-k">const</span> <span class="pl-k">int</span> ny = <span class="pl-c1">2048</span>;  <span class="pl-c"><span class="pl-c">//</span> çŸ©é˜µçš„yç»´åº¦</span>
  <span class="pl-k">const</span> <span class="pl-k">int</span> mem_size = nx*ny*<span class="pl-k">sizeof</span>(<span class="pl-k">double</span>);  <span class="pl-c"><span class="pl-c">//</span> çŸ©é˜µæ‰€éœ€çš„å†…å­˜å¤§å°</span>

  dim3 <span class="pl-smi">dimGrid</span>(nx/TILE_DIM, ny/TILE_DIM, <span class="pl-c1">1</span>);  <span class="pl-c"><span class="pl-c">//</span> ç½‘æ ¼ç»´åº¦</span>
  dim3 <span class="pl-smi">dimBlock</span>(TILE_DIM, BLOCK_ROWS, <span class="pl-c1">1</span>);  <span class="pl-c"><span class="pl-c">//</span> å—ç»´åº¦</span>

  <span class="pl-k">int</span> devId = <span class="pl-c1">0</span>;
  <span class="pl-k">if</span> (argc &gt; <span class="pl-c1">1</span>) devId = <span class="pl-c1">atoi</span>(argv[<span class="pl-c1">1</span>]);

  cudaDeviceProp prop;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaGetDeviceProperties</span>(&amp;prop, devId));
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span>Device : %s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, prop.<span class="pl-smi">name</span>);
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Matrix size: %d %d, Block size: %d %d, Tile size: %d %d<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, 
         nx, ny, TILE_DIM, BLOCK_ROWS, TILE_DIM, TILE_DIM);
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>dimGrid: %d %d %d. dimBlock: %d %d %d<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
         dimGrid.<span class="pl-smi">x</span>, dimGrid.<span class="pl-smi">y</span>, dimGrid.<span class="pl-smi">z</span>, dimBlock.<span class="pl-smi">x</span>, dimBlock.<span class="pl-smi">y</span>, dimBlock.<span class="pl-smi">z</span>);
  
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaSetDevice</span>(devId) );

  <span class="pl-k">double</span> *h_idata = (<span class="pl-k">double</span>*)<span class="pl-c1">malloc</span>(mem_size);  <span class="pl-c"><span class="pl-c">//</span> ä¸»æœºè¾“å…¥æ•°æ®</span>
  <span class="pl-k">double</span> *h_cdata = (<span class="pl-k">double</span>*)<span class="pl-c1">malloc</span>(mem_size);  <span class="pl-c"><span class="pl-c">//</span> ä¸»æœºå¤åˆ¶æ•°æ®</span>
  <span class="pl-k">double</span> *h_tdata = (<span class="pl-k">double</span>*)<span class="pl-c1">malloc</span>(mem_size);  <span class="pl-c"><span class="pl-c">//</span> ä¸»æœºè½¬ç½®æ•°æ®</span>
  <span class="pl-k">double</span> *gold    = (<span class="pl-k">double</span>*)<span class="pl-c1">malloc</span>(mem_size);  <span class="pl-c"><span class="pl-c">//</span> ä¸»æœºæ­£ç¡®ç»“æœ</span>
  
  <span class="pl-k">double</span> *d_idata, *d_cdata, *d_tdata;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_idata, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> è®¾å¤‡è¾“å…¥æ•°æ®</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_cdata, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> è®¾å¤‡å¤åˆ¶æ•°æ®</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMalloc</span>(&amp;d_tdata, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> è®¾å¤‡è½¬ç½®æ•°æ®</span>

  <span class="pl-c"><span class="pl-c">//</span> æ£€æŸ¥å‚æ•°å¹¶è®¡ç®—æ‰§è¡Œé…ç½®</span>
  <span class="pl-k">if</span> (nx % TILE_DIM || ny % TILE_DIM) {
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>nx å’Œ ny å¿…é¡»æ˜¯ TILE_DIM çš„å€æ•°<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
    <span class="pl-k">goto</span> error_exit;
  }

  <span class="pl-k">if</span> (TILE_DIM % BLOCK_ROWS) {
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>TILE_DIM å¿…é¡»æ˜¯ BLOCK_ROWS çš„å€æ•°<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
    <span class="pl-k">goto</span> error_exit;
  }
    
  <span class="pl-c"><span class="pl-c">//</span> åˆå§‹åŒ–ä¸»æœºè¾“å…¥æ•°æ®</span>
  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; ny; j++)
    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nx; i++)
      h_idata[j*nx + i] = j*nx + i;

  <span class="pl-c"><span class="pl-c">//</span> åˆå§‹åŒ–ä¸»æœºæ­£ç¡®ç»“æœ</span>
  <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; ny; j++)
    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; nx; i++)
      gold[j*nx + i] = h_idata[i*nx + j];
  
  <span class="pl-c"><span class="pl-c">//</span> å°†è¾“å…¥æ•°æ®ä»ä¸»æœºå¤åˆ¶åˆ°è®¾å¤‡</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(d_idata, h_idata, mem_size, cudaMemcpyHostToDevice) );
  
  <span class="pl-c"><span class="pl-c">//</span> ç”¨äºè®¡æ—¶çš„äº‹ä»¶</span>
  cudaEvent_t startEvent, stopEvent;
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventCreate</span>(&amp;startEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventCreate</span>(&amp;stopEvent) );
  <span class="pl-k">float</span> ms;

  <span class="pl-c"><span class="pl-c">//</span> ------------</span>
  <span class="pl-c"><span class="pl-c">//</span> å†…æ ¸è®¡æ—¶</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s%25s<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Routine<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Bandwidth (GB/s)<span class="pl-pds">"</span></span>);
  
  <span class="pl-c"><span class="pl-c">//</span> ----</span>
  <span class="pl-c"><span class="pl-c">//</span> å¤åˆ¶</span>
  <span class="pl-c"><span class="pl-c">//</span> ----</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>copy<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_cdata, <span class="pl-c1">0</span>, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç©ºè®¾å¤‡å¤åˆ¶æ•°æ®</span>
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  copy&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     copy&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_cdata, d_cdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(h_idata, h_cdata, nx*ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> -------------</span>
  <span class="pl-c"><span class="pl-c">//</span> ä½¿ç”¨å…±äº«å†…å­˜çš„å¤åˆ¶</span>
  <span class="pl-c"><span class="pl-c">//</span> -------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>shared memory copy<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_cdata, <span class="pl-c1">0</span>, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç©ºè®¾å¤‡å¤åˆ¶æ•°æ®</span>
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  copySharedMem&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     copySharedMem&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_cdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_cdata, d_cdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(h_idata, h_cdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> --------------</span>
  <span class="pl-c"><span class="pl-c">//</span> ç®€å•è½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> --------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>naive transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç©ºè®¾å¤‡è½¬ç½®æ•°æ®</span>
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeNaive&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeNaive&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> ------------------</span>
  <span class="pl-c"><span class="pl-c">//</span> åˆå¹¶è½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>coalesced transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç©ºè®¾å¤‡è½¬ç½®æ•°æ®</span>
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeCoalesced&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeCoalesced&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

  <span class="pl-c"><span class="pl-c">//</span> ------------------------</span>
  <span class="pl-c"><span class="pl-c">//</span> æ— bankå†²çªè½¬ç½®</span>
  <span class="pl-c"><span class="pl-c">//</span> ------------------------</span>
  <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>%25s<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>conflict-free transpose<span class="pl-pds">"</span></span>);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemset</span>(d_tdata, <span class="pl-c1">0</span>, mem_size) );  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç©ºè®¾å¤‡è½¬ç½®æ•°æ®</span>
  <span class="pl-c"><span class="pl-c">//</span> é¢„çƒ­</span>
  transposeNoBankConflicts&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(startEvent, <span class="pl-c1">0</span>) );
  <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; NUM_REPS; i++)
     transposeNoBankConflicts&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(d_tdata, d_idata);
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventRecord</span>(stopEvent, <span class="pl-c1">0</span>) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventSynchronize</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventElapsedTime</span>(&amp;ms, startEvent, stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaMemcpy</span>(h_tdata, d_tdata, mem_size, cudaMemcpyDeviceToHost) );
  <span class="pl-c1">postprocess</span>(gold, h_tdata, nx * ny, ms);

error_exit:
  <span class="pl-c"><span class="pl-c">//</span> æ¸…ç†</span>
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventDestroy</span>(startEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaEventDestroy</span>(stopEvent) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_tdata) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_cdata) );
  <span class="pl-c1">checkCuda</span>( <span class="pl-c1">cudaFree</span>(d_idata) );
  <span class="pl-c1">free</span>(h_idata);
  <span class="pl-c1">free</span>(h_tdata);
  <span class="pl-c1">free</span>(h_cdata);
  <span class="pl-c1">free</span>(gold);
}</pre></div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/cf73cb0ac4586045ca9ef0d3399ecc29d41b7467eea802a9b710acad4637afe5/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130333535373937302d313938303233363232322e706e67"><img src="https://camo.githubusercontent.com/cf73cb0ac4586045ca9ef0d3399ecc29d41b7467eea802a9b710acad4637afe5/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333130333535373937302d313938303233363232322e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603103557970-1980236222.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>è¿è¡Œç»“æœ</p>
</div>
<p>ç”±äºå…±äº«å†…å­˜çš„bankä¸º32ä½å³4å­—èŠ‚ï¼Œæ‰€ä»¥doubleå’Œfloatçš„ä¼˜åŒ–æœºåˆ¶ä¼šæœ‰äº›è®¸ä¸åŒã€‚<br>
å¯¹äºå†™å…¥Shared Memoryçš„æ“ä½œï¼š</p>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; <span class="pl-c1">16</span>; j += <span class="pl-c1">16</span>)
  tile[threadIdx.y+j][threadIdx.x] = idata[(y+j)*width + x];
<span class="pl-en">__syncthreads</span>();</pre></div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/c778f5b8536c85e9f004db962967d5fc1074564f3ae69e113b7baa9414d25988/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333134313233343539372d313834303436313138352e706e67"><img src="https://camo.githubusercontent.com/c778f5b8536c85e9f004db962967d5fc1074564f3ae69e113b7baa9414d25988/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333134313233343539372d313834303436313138352e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603141234597-1840461185.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>Doubleç±»å‹'ä¼ªåˆå¹¶è®¿å­˜'</p>
</div>
<p>å¯ä»¥æ³¨æ„åˆ°ï¼Œåœ¨æ¯ä¸ªwarpä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸¤ä¸ªdoubleæ•°æ®ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äºä¸‹è¿°ä»£ç æƒ…å†µï¼š</p>
<div class="highlight highlight-source-c++"><pre class="notranslate"><span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">0</span>; j &lt; <span class="pl-c1">16</span>; j += <span class="pl-c1">16</span>)
  odata[(y+j)*width + x] = tile[threadIdx.x][threadIdx.y + j];</pre></div>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f139ae38df7e4d47439287e4f54f43f26b1dbd41212914d8a46b11210d14ae74/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333134353934373938312d313235373939383237352e706e67"><img src="https://camo.githubusercontent.com/f139ae38df7e4d47439287e4f54f43f26b1dbd41212914d8a46b11210d14ae74/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333134353934373938312d313235373939383237352e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603145947981-1257998275.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>Doubleç±»å‹'ä¼ªéåˆå¹¶è®¿å­˜'</p>
</div>
<p>åœ¨å¦‚ä¸Šå›¾ä¸­ï¼Œæ¯ä¸ªbankä¸­éƒ½ä¼šå‘ç”Ÿ16è·¯bankå†²çªï¼Œæ‰€ä»¥æ”¹è¿›å¢åŠ paddingï¼š</p>
<div>
    <a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/7c645084b688847d458c6a332eb3e25d0f07d05be3e8af5161ab92cfba99bd84/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333135303530373433322d313337313736303634382e706e67"><img src="https://camo.githubusercontent.com/7c645084b688847d458c6a332eb3e25d0f07d05be3e8af5161ab92cfba99bd84/68747470733a2f2f696d67323032342e636e626c6f67732e636f6d2f626c6f672f333335383138322f3230323430362f333335383138322d32303234303630333135303530373433322d313337313736303634382e706e67" height="200" data-canonical-src="https://img2024.cnblogs.com/blog/3358182/202406/3358182-20240603150507432-1371760648.png" style="max-width: 100%; height: auto; max-height: 200px;"></a>
    <p>Doubleç±»å‹'ä¼ªéåˆå¹¶è®¿å­˜'</p>
</div>
<div class="markdown-alert markdown-alert-caution"><p class="markdown-alert-title"><svg class="octicon octicon-stop mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p><p>åœ¨è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆåŒä¸€ä¸ªwarpä¸­çš„å‰16ä¸ªçº¿ç¨‹å’Œå16ä¸ªçº¿ç¨‹ä¸ä¼šå‘ç”Ÿbank conflictå‘¢ï¼Ÿäº‹å®ä¸Šï¼Œè¦è¾©è¯æ·±å…¥æœ¬è´¨çœ‹bank conflictçš„å®šä¹‰ï¼Œå½“Shared Memoryçš„32ä¸ªbankå‘ç”ŸéåŒæ—¶è®¿é—®(å³éƒ¨åˆ†bankæœ‰ä¸€ä¸ªaccessï¼Œå¦å¤–éƒ¨åˆ†ä¸åªæœ‰ä¸€ä¸ªaccess)æ—¶ï¼Œç”±äºå¤šä¸ªè®¿é—®åŒæ—¶è®¿é—®ä¸€ä¸ªbankï¼Œå¯¼è‡´äº§ç”Ÿé¡ºåºè®¿é—®ï¼Œæ‹–æ…¢äº†è®¿å­˜èŠ‚å¥ï¼Œæ­¤æ—¶å°±ä¼šäº§ç”Ÿbank conflictã€‚è€Œåœ¨è¿™é‡Œç”±äºæ¯æ¬¡è®¿é—®éƒ½ä¼šå°†32ä¸ªbankåŒæ—¶è®¿é—®ï¼Œä¹Ÿå°±æ˜¯å æ»¡äº†Shared Memoryçš„å¸¦å®½ï¼Œå½“ç„¶ä¹Ÿå°±ä¸ä¼šå‘ç”Ÿå†²çªã€‚</p>
</div>
<hr>
<p><strong>REFERENCE(æ„Ÿè°¢å¼•ç”¨)ï¼š</strong></p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/692010210" rel="nofollow">[CUDA å­¦ä¹ ç¬”è®°] çŸ©é˜µè½¬ç½®ç®—å­ä¼˜åŒ–</a></li>
<li><a href="https://developer.nvidia.com/blog/efficient-matrix-transpose-cuda-cc/" rel="nofollow">An Efficient Matrix Transpose in CUDA C/C++</a></li>
</ul></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">è¯„è®º</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright Â© <span id="copyrightYear"></span> <a href="https://jibinghu.github.io">ZOMBIE_</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if("05/28/2024"!=""){
    var startSite=new Date("05/28/2024");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="ç½‘ç«™è¿è¡Œ"+diffDay+"å¤©"+" â€¢ ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","jibinghu/jibinghu.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>
<script>MathJax = {tex: {inlineMath: [["$", "$"]]}};</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</html>
